<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Monicz Exclusive</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  html, body, #root { height: 100%; }
</style>
</head>
<body class="bg-[#1E1E1E]">
<div id="root"></div>

<!-- React 18 UMD & Babel Standalone -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- IMPORTANT: add presets so JSX + modern JS parse correctly -->
<script type="text/babel" data-presets="env,react">
/**
 * Monicz Exclusive — Full App
 * - Inventory search in Products panel (multi-term across name/category/price/stock)
 * - "Clear Inventory" action removed from Products panel
 */

// ------------------------------
// Google Sheet backend service
// ------------------------------
const GS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwHmHwKUIGhH22MsjZFxXnsWakPGh7abgK67EVNB4PVa9lN1O3fGSX58RUR252jnoEy/exec";

// helper: send a "simple" POST (no headers) to avoid CORS preflight
async function postJSONSimple(url, payload) {
  const r = await fetch(url, {
    method: "POST",
    // IMPORTANT: no headers here (browser will default to text/plain)
    body: JSON.stringify(payload),
  });
  const text = await r.text();
  let j;
  try { j = JSON.parse(text); } catch { throw new Error("Non-JSON response from script: " + text.slice(0,120)); }
  return j;
}

const GSSvc = {
  async fetchAll() {
    const r = await fetch(`${GS_ENDPOINT}?action=fetchAll`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "fetchAll failed");
    const products = (j.data.products || []).map(p => ({
      ...p,
      price: Number(p.price) || 0,
      stock: Number(p.stock) || 0,
      lowStock: Number(p.lowStock) || 0,
    }));
    const sales = (j.data.sales || []).map(s => ({
      ...s,
      total: Number(s.total) || 0,
      items: (() => { try { return JSON.parse(s.items_json||"[]"); } catch { return []; } })(),
    }));
    const expenses = (j.data.expenses || []).map(e => ({ ...e, amount: Number(e.amount) || 0 }));
    return { products, sales, expenses };
  },
  async saveProducts(products) {
    const j = await postJSONSimple(GS_ENDPOINT, { action: "saveProducts", products });
    if (!j.ok) throw new Error(j.error || "saveProducts failed");
  },
  async addSale(sale) {
    const j = await postJSONSimple(GS_ENDPOINT, { action: "addSale", sale });
    if (!j.ok) throw new Error(j.error || "addSale failed");
  },
  async addExpense(expense) {
    const j = await postJSONSimple(GS_ENDPOINT, { action: "addExpense", expense });
    if (!j.ok) throw new Error(j.error || "addExpense failed");
  },
  async deleteProduct(id) {
    const j = await postJSONSimple(GS_ENDPOINT, { action: "deleteProduct", id });
    if (!j.ok) throw new Error(j.error || "deleteProduct failed");
  },
  async clearProducts() {
    const j = await postJSONSimple(GS_ENDPOINT, { action: "clearProducts" });
    if (!j.ok) throw new Error(j.error || "clearProducts failed");
  },
};

const { useEffect, useMemo, useRef, useState } = React;

// ---------- Error helper ----------
function showSyncError(context, err) {
  console.error(`${context} failed:`, err);
  const msg = err?.message || (typeof err === 'string' ? err : JSON.stringify(err));
  alert(`${context} failed:\n${msg}`);
}

// Font Awesome icon wrappers
const ShoppingCart = (p) => <i className={`fa-solid fa-cart-shopping text-[20px] ${p.className||""}`}></i>;
const LogIn = (p) => <i className={`fa-solid fa-right-to-bracket text-[20px] ${p.className||""}`}></i>;
const LogOut = (p) => <i className={`fa-solid fa-right-from-bracket text-[20px] ${p.className||""}`}></i>;
const Package = (p) => <i className={`fa-solid fa-box text-[20px] ${p.className||""}`}></i>;
const BarChart3 = (p) => <i className={`fa-regular fa-chart-bar text-[20px] ${p.className||""}`}></i>;
const Wallet = (p) => <i className={`fa-solid fa-wallet text-[20px] ${p.className||""}`}></i>;
const AlertTriangle = (p) => <i className={`fa-solid fa-triangle-exclamation text-[20px] ${p.className||""}`}></i>;
const FileText = (p) => <i className={`fa-regular fa-file-lines text-[20px] ${p.className||""}`}></i>;
const History = (p) => <i className={`fa-solid fa-clock-rotate-left text-[20px] ${p.className||""}`}></i>;
const Plus = (p) => <i className={`fa-solid fa-plus text-[20px] ${p.className||""}`}></i>;
const Trash2 = (p) => <i className={`fa-solid fa-trash text-[20px] ${p.className||""}`}></i>;
const Edit3 = (p) => <i className={`fa-regular fa-pen-to-square text-[20px] ${p.className||""}`}></i>;
const Download = (p) => <i className={`fa-solid fa-download text-[20px] ${p.className||""}`}></i>;
const Upload = (p) => <i className={`fa-solid fa-upload text-[20px] ${p.className||""}`}></i>;

// ------------------------------
// Helpers & Storage
// ------------------------------
const LS_KEY = "monicz_exclusive_app_v1";
const nowISO = () => new Date().toISOString();
const fmt = (n) => (Number.isFinite(n) ? n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00");

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
function saveState(state) {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function uid(prefix = "id") {
  return `${prefix}_${Math.random().toString(36).slice(2, 9)}`;
}
function withinDays(iso, days) {
  const then = new Date(iso).getTime();
  const diff = Date.now() - then;
  return diff <= days * 24 * 60 * 60 * 1000;
}

// CSV utilities
function csvStringify(rows) {
  if (!rows || !rows.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = (v) => {
    const s = v == null ? "" : String(v);
    if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  };
  return [headers.join(","), ...rows.map((r) => headers.map((h) => esc(r[h])).join(","))].join("\n");
}
function csvParse(text) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  function pushField() { row.push(field); field = ''; }
  function pushRow() { rows.push(row); row = []; }
  while (i < text.length) {
    const c = text[i++];
    if (inQuotes) {
      if (c === '"') {
        if (text[i] === '"') { field += '"'; i++; }
        else { inQuotes = false; }
      } else field += c;
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') pushField();
      else if (c === '\n') { pushField(); pushRow(); }
      else if (c === '\r') { /* ignore */ }
      else field += c;
    }
  }
  pushField(); pushRow();
  if (rows.length && rows[rows.length - 1].every((x) => x === '')) rows.pop();
  return rows;
}
function csvToObjects(text) {
  const matrix = csvParse(text);
  if (!matrix.length) return [];
  const headers = matrix[0].map((h) => h.trim());
  return matrix.slice(1).map((cells) => {
    const obj = {};
    headers.forEach((h, idx) => (obj[h] = (cells[idx] ?? '').trim()));
    return obj;
  });
}

// ------------------------------
// Seed Data
// ------------------------------
const initialState = {
  users: [
    { username: "admin", role: "admin", password: "monicamylove" },
    { username: "client", role: "client", password: "client123" },
  ],
  currentUser: null, // { username, role }
  products: [],
  sales: [],
  expenses: [],
  settings: { currency: "₦", lowStockDefault: 10 },
};

// ------------------------------
// UI Building Blocks
// ------------------------------
function Card({ title, icon, children, className = "" }) {
  const Icon = icon || Package;
  return (
    <div className={`bg-[#2C2C2C] text-white rounded-2xl shadow-sm border border-slate-700 p-5 ${className}`}>
      <div className="flex items-center gap-2 mb-3">
        <Icon className="w-5 h-5" />
        <h3 className="font-semibold">{title}</h3>
      </div>
      {children}
    </div>
  );
}
function Button({ title, children, onClick, variant = "primary", className = "", type = "button" }) {
  const styles =
    variant === "ghost"
      ? "bg-transparent hover:bg-slate-800 border border-slate-600 text-white"
      : variant === "danger"
      ? "bg-red-600 hover:bg-red-700 text-white"
      : variant === "secondary"
      ? "bg-slate-700 hover:bg-slate-800 text-white"
      : "bg-blue-600 hover:bg-blue-700 text-white";
  return (
    <button type={type} onClick={onClick} className={`px-3 py-2 rounded-xl text-sm font-medium ${styles} ${className}`}>
      {children || title}
    </button>
  );
}
function TextInput({ label, value, onChange, type = "text", placeholder = "", className = "", step }) {
  const asNumber = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  };
  return (
    <label className={`block ${className}`}>
      <span className="text-xs text-gray-300">{label}</span>
      <input
        type={type}
        step={step}
        className="mt-1 w-full rounded-xl border border-slate-600 bg-[#1E1E1E] text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        value={value}
        placeholder={placeholder}
        onChange={(e) => onChange(type === "number" ? asNumber(e.target.value) : e.target.value)}
      />
    </label>
  );
}
function Table({ columns, rows, empty = "No data" }) {
  return (
    <div className="overflow-auto border border-slate-700 rounded-xl">
      <table className="w-full text-sm">
        <thead className="bg-slate-800 text-slate-200">
          <tr>
            {columns.map((c) => (
              <th key={c.key} className="text-left px-3 py-2 whitespace-nowrap">
                {c.title}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.length === 0 ? (
            <tr>
              <td className="px-3 py-4 text-slate-400" colSpan={columns.length}>
                {empty}
              </td>
            </tr>
          ) : (
            rows.map((r, i) => (
              <tr key={i} className="border-t border-slate-700">
                {columns.map((c) => (
                  <td key={c.key} className="px-3 py-2 align-top whitespace-nowrap">
                    {typeof c.render === "function" ? c.render(r) : r[c.key]}
                  </td>
                ))}
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
}

// ------------------------------
// App Root
// ------------------------------
function App() {
  const [state, setState] = useState(() => loadState() || initialState);
  const [booted, setBooted] = useState(false);

  useEffect(() => saveState(state), [state]);

  // On first mount, try pulling data from Google Sheets
  useEffect(() => {
    (async () => {
      try {
        const remote = await GSSvc.fetchAll();
        setState(s => ({
          ...s,
          products: remote.products,
          sales: remote.sales,
          expenses: remote.expenses,
        }));
      } catch (e) {
        console.warn("Using local data (could not reach Google Sheets):", e);
      } finally {
        setBooted(true);
      }
    })();
  }, []);

  if (!booted) {
    return (
      <div className="min-h-screen grid place-items-center text-white">Loading…</div>
    );
  }

  function login(username, password) {
    const u = username.trim().toLowerCase();
    const found = state.users.find((usr) => usr.username.toLowerCase() === u && usr.password === password);
    if (found) setState((s) => ({ ...s, currentUser: { username: found.username, role: found.role } }));
    else alert("Invalid credentials");
  }
  function logout() {
    setState((s) => ({ ...s, currentUser: null }));
  }

  if (!state.currentUser) return <Login onLogin={login} />;

  return (
    <div className="min-h-screen bg-[#1E1E1E] text-white">
      <TopBar user={state.currentUser} onLogout={logout} />
      {state.currentUser.role === "admin" ? (
        <AdminApp state={state} setState={setState} />
      ) : (
        <ClientApp state={state} setState={setState} />
      )}
    </div>
  );
}

// ------------------------------
// Login & TopBar
// ------------------------------
function Login({ onLogin }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");

  function handleSubmit(e) {
    e.preventDefault();
    onLogin(username, password);
  }

  return (
    <div className="min-h-screen grid place-items-center bg-[#1E1E1E] text-white">
      <form onSubmit={handleSubmit} className="bg-[#2C2C2C] w-full max-w-md p-8 rounded-2xl shadow-sm border border-slate-700">
        <div className="flex items-center gap-2 mb-4">
          <LogIn className="w-5 h-5" />
          <h1 className="font-semibold text-lg">Monicz Exclusive Login</h1>
        </div>
        <TextInput label="Username" value={username} onChange={setUsername} />
        <TextInput className="mt-3" label="Password" value={password} onChange={setPassword} type="password" />
        <div className="mt-4 flex items-center gap-2">
          <Button type="submit" title="Login" />
        </div>
      </form>
    </div>
  );
}
function TopBar({ user, onLogout }) {
  return (
    <div className="sticky top-0 z-10 bg-[#2C2C2C] border-b border-slate-700">
      <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <ShoppingCart className="w-5 h-5" />
          <span className="font-semibold">Monicz Exclusive</span>
          <span className="text-xs text-slate-400 ml-2">Role: {user.role}</span>
        </div>
        <Button variant="ghost" onClick={onLogout}>
          <LogOut className="w-4 h-4 mr-1" /> Logout
        </Button>
      </div>
    </div>
  );
}

// ------------------------------
// Admin App
// ------------------------------
function KPI({ label, value }) {
  return (
    <div className="bg-[#1E1E1E] rounded-xl py-3 border border-slate-700 text-center">
      <div className="text-xs text-slate-400">{label}</div>
      <div className="text-lg font-semibold">{value}</div>
    </div>
  );
}
function TabButton({ icon: Icon, label, active, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`flex items-center gap-2 px-3 py-2 rounded-xl text-sm border ${active ? "bg-blue-600 text-white border-blue-600" : "bg-[#2C2C2C] border-slate-700 hover:bg-slate-800"}`}
    >
      <Icon className="w-4 h-4" /> {label}
    </button>
  );
}
function AdminApp({ state, setState }) {
  const [tab, setTab] = useState("dashboard");
  const { products, sales, expenses, settings } = state;

  const totals = useMemo(() => {
    const today = sales.filter((s) => withinDays(s.date, 1)).reduce((a, s) => a + s.total, 0);
    const week = sales.filter((s) => withinDays(s.date, 7)).reduce((a, s) => a + s.total, 0);
    const month = sales.filter((s) => withinDays(s.date, 30)).reduce((a, s) => a + s.total, 0);
    const inventoryValue = products.reduce((a, p) => a + (p.price || 0) * (p.stock || 0), 0);
    const revenue = sales.reduce((a, s) => a + s.total, 0);
    const expenseTotal = expenses.reduce((a, e) => a + e.amount, 0);
    const balance = revenue - expenseTotal;
    const lowStock = products.filter((p) => (p.stock || 0) <= (p.lowStock || settings.lowStockDefault));
    return { today, week, month, inventoryValue, revenue, expenseTotal, balance, lowStock };
  }, [products, sales, expenses, settings.lowStockDefault]);

  return (
    <div className="max-w-6xl mx-auto px-4 py-6">
      <nav className="flex flex-wrap gap-2 mb-4">
        <TabButton icon={BarChart3} label="Dashboard" active={tab === "dashboard"} onClick={() => setTab("dashboard")} />
        <TabButton icon={Package} label="Products" active={tab === "products"} onClick={() => setTab("products")} />
        <TabButton icon={ShoppingCart} label="Record Sale" active={tab === "sell"} onClick={() => setTab("sell")} />
        <TabButton icon={History} label="Sales History" active={tab === "sales"} onClick={() => setTab("sales")} />
        <TabButton icon={Wallet} label="Expenses" active={tab === "expenses"} onClick={() => setTab("expenses")} />
        <TabButton icon={FileText} label="Reports" active={tab === "reports"} onClick={() => setTab("reports")} />
      </nav>

      {tab === "dashboard" && (
        <div className="grid md:grid-cols-2 gap-4">
          <Card title="Sales Summary" icon={BarChart3}>
            <div className="grid grid-cols-3 gap-3 text-center">
              <KPI label="Today" value={`${state.settings.currency}${fmt(totals.today)}`} />
              <KPI label="This Week" value={`${state.settings.currency}${fmt(totals.week)}`} />
              <KPI label="This Month" value={`${state.settings.currency}${fmt(totals.month)}`} />
            </div>
          </Card>
          <Card title="Inventory & Balance" icon={Wallet}>
            <div className="grid grid-cols-3 gap-3 text-center">
              <KPI label="Inventory Value" value={`${state.settings.currency}${fmt(totals.inventoryValue)}`} />
              <KPI label="Revenue" value={`${state.settings.currency}${fmt(totals.revenue)}`} />
              <KPI label="Balance (Rev - Exp)" value={`${state.settings.currency}${fmt(totals.balance)}`} />
            </div>
          </Card>
          <Card title="Low Stock Alerts" icon={AlertTriangle} className="md:col-span-2">
            <Table
              columns={[
                { key: "name", title: "Product" },
                { key: "stock", title: "Stock" },
                { key: "low", title: "Min" },
              ]}
              rows={totals.lowStock.map((p) => ({ name: p.name, stock: p.stock, low: p.lowStock || state.settings.lowStockDefault }))}
              empty="No low stock items"
            />
          </Card>
        </div>
      )}

      {tab === "products" && <ProductsPanel state={state} setState={setState} />}
      {tab === "sell" && <RecordSalePanel state={state} setState={setState} />}
      {tab === "sales" && <SalesHistoryPanel state={state} />}
      {tab === "expenses" && <ExpensesPanel state={state} setState={setState} />}
      {tab === "reports" && <ReportsPanel state={state} />}
    </div>
  );
}

// ------------------------------
// Products Panel (Admin) — with Inventory Search, no Clear Inventory
// ------------------------------
function ProductsPanel({ state, setState }) {
  const [form, setForm] = useState({ name: "", category: "", price: 0, stock: 0, lowStock: state.settings.lowStockDefault });
  const [editing, setEditing] = useState(null);
  const [bulk, setBulk] = useState("");
  const [invQuery, setInvQuery] = useState(""); // inventory search query
  const fileRef = useRef(null);

  // Filtered rows for the Inventory table (multi-term, across fields)
  const filteredProducts = useMemo(() => {
    const q = invQuery.trim().toLowerCase();
    if (!q) return state.products;
    const terms = q.split(/\s+/).filter(Boolean);
    return state.products.filter((p) => {
      const hay = [
        p.name ?? "",
        p.category ?? "",
        String(p.price ?? ""),
        String(p.stock ?? "")
      ].join(" ").toLowerCase();
      return terms.every((t) => hay.includes(t));
    });
  }, [state.products, invQuery]);

  async function addOrUpdateProduct(e) {
    e.preventDefault();
    if (!form.name) return alert("Name required");

    let nextProducts;
    setState((s) => {
      if (editing) {
        nextProducts = s.products.map((p) => (p.id === editing ? { ...p, ...form } : p));
      } else {
        nextProducts = [...s.products, { id: uid("p"), ...form }];
      }
      return { ...s, products: nextProducts };
    });

    try {
      await GSSvc.saveProducts(nextProducts);
    } catch (err) {
      showSyncError("Sync to Google Sheets (saveProducts)", err);
    }

    setEditing(null);
    setForm({ name: "", category: "", price: 0, stock: 0, lowStock: state.settings.lowStockDefault });
  }

  function editProduct(p) {
    setForm({ name: p.name, category: p.category, price: p.price, stock: p.stock, lowStock: p.lowStock || state.settings.lowStockDefault });
    setEditing(p.id);
  }

  async function delProduct(id) {
    if (!confirm("Delete product?")) return;
    setState((s) => ({ ...s, products: s.products.filter((p) => p.id !== id) }));
    try {
      await GSSvc.deleteProduct(id);
    } catch (err) {
      showSyncError("Sync to Google Sheets (deleteProduct)", err);
    }
  }

  function upsertProducts(existing, incoming) {
    const byName = new Map(existing.map((p) => [p.name.toLowerCase(), p]));
    const next = [...existing];
    for (const inc of incoming) {
      const key = inc.name.toLowerCase();
      if (byName.has(key)) {
        const idx = next.findIndex((p) => p.name.toLowerCase() === key);
        next[idx] = { ...next[idx], ...inc, id: next[idx].id };
      } else {
        next.push(inc);
      }
    }
    return next;
  }

  async function parseBulk() {
    const lines = bulk.split(/\n|\r/).map((l) => l.trim()).filter(Boolean);
    const parsed = [];
    for (const line of lines) {
      const [name, category = "", price = "0", stock = "0", low = String(state.settings.lowStockDefault)] = line.split(",").map((s) => s.trim());
      if (!name) continue;
      parsed.push({ id: uid("p"), name, category, price: Number(price) || 0, stock: Number(stock) || 0, lowStock: Number(low) || state.settings.lowStockDefault });
    }
    if (!parsed.length) return alert("No valid lines found.");
    let nextProducts;
    setState((s) => {
      nextProducts = upsertProducts(s.products, parsed);
      return { ...s, products: nextProducts };
    });
    setBulk("");
    try {
      await GSSvc.saveProducts(nextProducts);
      alert(`Imported ${parsed.length} products (merged by name).`);
    } catch (err) {
      showSyncError("Sync to Google Sheets (saveProducts after parseBulk)", err);
    }
  }

  // --- CSV Import (file upload) ---
  function handleImportFile(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const text = String(reader.result || "");
        const objs = csvToObjects(text);
        if (!objs.length) return alert("CSV appears empty.");
        const normalized = objs.map((o) => ({
          id: uid("p"),
          name: o.name || o.Name || o.product || o.Product || "",
          category: o.category || o.Category || "",
          price: Number(o.price ?? o.Price ?? 0) || 0,
          stock: Number(o.stock ?? o.Stock ?? 0) || 0,
          lowStock: Number(o.lowStock ?? o.LowStock ?? o.min ?? o.Min ?? state.settings.lowStockDefault) || state.settings.lowStockDefault,
        })).filter((x) => x.name);
        if (!normalized.length) return alert("No valid rows with a 'name' column.");

        let nextProducts;
        setState((s) => {
          nextProducts = upsertProducts(s.products, normalized);
          return { ...s, products: nextProducts };
        });

        try {
          await GSSvc.saveProducts(nextProducts);
          alert(`Imported ${normalized.length} products (merged by name).`);
        } catch (err) {
          showSyncError("Sync to Google Sheets (saveProducts after file import)", err);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to import CSV. Please check the file format.");
      } finally {
        if (fileRef.current) fileRef.current.value = '';
      }
    };
    reader.readAsText(file);
  }

  // --- CSV Export (products) ---
  function exportProducts() {
    const rows = state.products.map((p) => ({ name: p.name, category: p.category, price: p.price, stock: p.stock, lowStock: p.lowStock }));
    const csv = csvStringify(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "products.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  return (
    <div className="grid md:grid-cols-3 gap-4">
      <Card title={editing ? "Edit Product" : "Add Product"} icon={Package}>
        <form onSubmit={addOrUpdateProduct} className="grid gap-3">
          <TextInput label="Name" value={form.name} onChange={(v) => setForm((f) => ({ ...f, name: v }))} />
          <TextInput label="Category" value={form.category} onChange={(v) => setForm((f) => ({ ...f, category: v }))} />
          <div className="grid grid-cols-3 gap-3">
            <TextInput label="Price" type="number" step="0.01" value={form.price} onChange={(v) => setForm((f) => ({ ...f, price: v }))} />
            <TextInput label="Stock" type="number" value={form.stock} onChange={(v) => setForm((f) => ({ ...f, stock: v }))} />
            <TextInput label="Low Stock Min" type="number" value={form.lowStock} onChange={(v) => setForm((f) => ({ ...f, lowStock: v }))} />
          </div>
          <div className="flex items-center gap-2">
            <Button type="submit" title={editing ? "Save" : "Add"} />
            {editing && (
              <>
                <Button variant="ghost" onClick={() => (setEditing(null), setForm({ name: "", category: "", price: 0, stock: 0, lowStock: state.settings.lowStockDefault }))}>
                  Cancel
                </Button>
                <Button variant="danger" onClick={() => delProduct(editing)}>
                  <Trash2 className="w-4 h-4 mr-1" /> Delete
                </Button>
              </>
            )}
          </div>
        </form>
      </Card>

      <Card title="Bulk / CSV Tools" icon={Plus}>
        <p className="text-xs text-slate-400 mb-2">Paste lines (<code>name, category, price, stock, lowStock</code>) or import a CSV file. Paste/CSV will <b>merge by name</b>.</p>
        <textarea value={bulk} onChange={(e) => setBulk(e.target.value)} className="w-full h-28 border border-slate-700 bg-[#1E1E1E] text-white rounded-xl p-2" placeholder={`Indomie, Noodles, 250, 52, 10\nGolden Morn, Cereal, 1200, 45, 8`} />
        <div className="mt-2 flex flex-wrap gap-2">
          <Button onClick={parseBulk} title="Add From Lines" />
          <Button variant="secondary" onClick={exportProducts}>
            <Download className="w-4 h-4 mr-1" /> Export Products CSV
          </Button>
          <label className="px-3 py-2 rounded-xl text-sm font-medium bg-slate-700 hover:bg-slate-800 cursor-pointer inline-flex items-center gap-2">
            <Upload className="w-4 h-4" /> Import Products CSV
            <input ref={fileRef} onChange={handleImportFile} type="file" accept=".csv,text/csv" className="hidden" />
          </label>
          {/* Clear Inventory button removed as requested */}
        </div>
      </Card>

      <Card title="Inventory" icon={Package} className="md:col-span-2">
        {/* Search bar + match count */}
        <div className="mb-3 flex items-end gap-2">
          <div className="flex-1">
            <TextInput
              label="Search inventory"
              value={invQuery}
              onChange={setInvQuery}
              placeholder="e.g. noodles cereal 250"
            />
          </div>
          {invQuery && (
            <Button variant="ghost" onClick={() => setInvQuery("")}>Clear</Button>
          )}
        </div>

        <div className="text-xs text-slate-400 mb-2">
          Showing <b>{filteredProducts.length}</b> of {state.products.length}
        </div>

        <Table
          columns={[
            { key: "name", title: "Product" },
            { key: "category", title: "Category" },
            { key: "price", title: "Price", render: (r) => `${(r.price ?? 0).toFixed(2)}` },
            { key: "stock", title: "Stock" },
            { key: "low", title: "Min", render: (r) => r.lowStock },
            {
              key: "actions",
              title: "",
              render: (r) => (
                <div className="flex gap-2">
                  <Button variant="secondary" onClick={() => editProduct(r)}>
                    <Edit3 className="w-4 h-4" />
                  </Button>
                  <Button variant="danger" onClick={() => delProduct(r.id)}>
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              ),
            },
          ]}
          rows={filteredProducts}
          empty={invQuery ? "No products match your search" : "No products yet. Add some on the left or paste CSV lines."}
        />
      </Card>
    </div>
  );
}

// ------------------------------
// Record Sale (Admin & Client reuse)
// ------------------------------
function RecordSalePanel({ state, setState }) {
  const [cart, setCart] = useState([]);
  const [filter, setFilter] = useState("");

  const products = useMemo(() => {
    const f = filter.trim().toLowerCase();
    return f ? state.products.filter((p) => p.name.toLowerCase().includes(f) || (p.category || '').toLowerCase().includes(f)) : state.products;
  }, [state.products, filter]);

  const total = cart.reduce((a, it) => a + it.qty * it.price, 0);

  function addToCart(p) {
    if (p.stock <= 0) return alert("Out of stock");
    setCart((c) => {
      const i = c.findIndex((x) => x.productId === p.id);
      if (i >= 0) {
        const next = [...c];
        next[i] = { ...next[i], qty: next[i].qty + 1 };
        return next;
      }
      return [...c, { productId: p.id, name: p.name, qty: 1, price: p.price || 0 }];
    });
  }

  function updateQty(id, qty) {
    setCart((c) => c.map((x) => (x.productId === id ? { ...x, qty: Math.max(1, qty) } : x)));
  }
  function removeFromCart(id) {
    setCart((c) => c.filter((x) => x.productId !== id));
  }

  async function completeSale() {
    if (!cart.length) return alert("Cart is empty");
    for (const it of cart) {
      const p = state.products.find((p) => p.id === it.productId);
      if (!p || p.stock < it.qty) return alert(`Insufficient stock for ${it?.name}`);
    }
    const items = cart.map((it) => ({ ...it, subtotal: it.qty * it.price }));
    const sale = { id: uid("s"), date: nowISO(), items, total, user: state.currentUser.username };

    let updatedProducts;
    setState((s) => {
      updatedProducts = s.products.map((p) => {
        const line = cart.find((it) => it.productId === p.id);
        return line ? { ...p, stock: p.stock - line.qty } : p;
      });
      return { ...s, sales: [sale, ...s.sales], products: updatedProducts };
    });
    setCart([]);

    try {
      await Promise.all([
        GSSvc.addSale(sale),
        GSSvc.saveProducts(updatedProducts),
      ]);
      alert("Sale recorded");
    } catch (err) {
      showSyncError("Sync to Google Sheets (addSale/saveProducts)", err);
    }
  }

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="Pick Products" icon={ShoppingCart}>
        <div className="mb-2">
          <TextInput label="Search" value={filter} onChange={setFilter} placeholder="Name or category" />
        </div>
        <div className="grid grid-cols-2 gap-2 max-h-96 overflow-auto pr-1">
          {products.map((p) => (
            <button key={p.id} onClick={() => addToCart(p)} className="border border-slate-700 rounded-xl p-2 text-left hover:bg-slate-800">
              <div className="font-medium">{p.name}</div>
              <div className="text-xs text-slate-400">{p.category || "Uncategorized"}</div>
              <div className="text-xs">Price: {state.settings.currency}{(p.price || 0).toFixed(2)} • Stock: {p.stock}</div>
            </button>
          ))}
          {products.length === 0 && <div className="text-sm text-slate-400">No products. Add some in Products tab.</div>}
        </div>
      </Card>

      <Card title="Cart & Checkout" icon={Wallet}>
        <Table
          columns={[
            { key: "name", title: "Item" },
            { key: "qty", title: "Qty", render: (r) => (
              <input type="number" className="w-20 border border-slate-700 bg-[#1E1E1E] text-white rounded-lg px-2 py-1" value={r.qty} onChange={(e) => updateQty(r.productId, Number(e.target.value))} />
            ) },
            { key: "price", title: "Price", render: (r) => `${state.settings.currency}${(r.price || 0).toFixed(2)}` },
            { key: "subtotal", title: "Subtotal", render: (r) => `${state.settings.currency}${(r.qty * (r.price || 0)).toFixed(2)}` },
            { key: "actions", title: "", render: (r) => (
              <Button variant="danger" onClick={() => removeFromCart(r.productId)}>
                <Trash2 className="w-4 h-4" />
              </Button>
            ) },
          ]}
          rows={cart}
          empty="No items in cart"
        />
        <div className="mt-3 flex items-center justify-between">
          <div className="text-sm">Total:</div>
          <div className="text-lg font-semibold">{state.settings.currency}{total.toFixed(2)}</div>
        </div>
        <div className="mt-3 flex gap-2">
          <Button onClick={completeSale} title="Complete Sale" />
          <Button variant="ghost" onClick={() => setCart([])} title="Clear" />
        </div>
      </Card>
    </div>
  );
}

// ------------------------------
// Sales History (Admin & Client)
// ------------------------------
function SalesHistoryPanel({ state }) {
  const [range, setRange] = useState("30");
  const filtered = useMemo(() => {
    const days = Number(range) || 3650;
    return state.sales.filter((s) => withinDays(s.date, days));
  }, [state.sales, range]);

  return (
    <div className="grid gap-4">
      <Card title="Filters" icon={History}>
        <div className="flex items-end gap-3">
          <TextInput label="Last N days" type="number" value={Number(range)} onChange={setRange} />
          <ExportCSV filename="sales.csv" rows={state.sales} mapRow={(s) => ({ id: s.id, date: s.date, total: s.total, items: s.items.map((i) => `${i.name} x${i.qty}`).join("; "), user: s.user })} />
        </div>
      </Card>
      <Card title="Sales" icon={ShoppingCart}>
        <Table
          columns={[
            { key: "date", title: "Date", render: (r) => new Date(r.date).toLocaleString() },
            { key: "user", title: "User" },
            { key: "items", title: "Items", render: (r) => r.items.map((i) => `${i.name} x${i.qty}`).join(", ") },
            { key: "total", title: "Total", render: (r) => `${state.settings.currency}${r.total.toFixed(2)}` },
          ]}
          rows={filtered}
          empty="No sales yet"
        />
      </Card>
    </div>
  );
}
function ExportCSV({ filename, rows, mapRow }) {
  function download() {
    if (!rows.length) return alert("No data to export");
    const data = rows.map(mapRow);
    const headers = Object.keys(data[0] || { example: "no_data" });
    const csv = [headers.join(","), ...data.map((r) => headers.map((h) => JSON.stringify(r[h] ?? "")).join(","))].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  return (
    <Button onClick={download} variant="secondary">
      <Download className="w-4 h-4 mr-1" /> Export CSV
    </Button>
  );
}

// ------------------------------
// Expenses (Admin)
// ------------------------------
function ExpensesPanel({ state, setState }) {
  const [form, setForm] = useState({ amount: 0, category: "Rent", note: "" });

  async function addExpense(e) {
    e.preventDefault();
    if (!form.amount) return alert("Enter amount");
    const exp = { id: uid("e"), date: nowISO(), amount: Number(form.amount), category: form.category, note: form.note };
    setState((s) => ({ ...s, expenses: [exp, ...s.expenses] }));
    setForm({ amount: 0, category: "Rent", note: "" });

    try {
      await GSSvc.addExpense(exp);
    } catch (err) {
      showSyncError("Sync to Google Sheets (addExpense)", err);
    }
  }

  const total = state.expenses.reduce((a, e) => a + e.amount, 0);

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="Add Expense" icon={Wallet}>
        <form onSubmit={addExpense} className="grid gap-3">
          <div className="grid grid-cols-3 gap-3">
            <TextInput label="Amount" type="number" step="0.01" value={form.amount} onChange={(v) => setForm((f) => ({ ...f, amount: v }))} />
            <TextInput label="Category" value={form.category} onChange={(v) => setForm((f) => ({ ...f, category: v }))} />
            <TextInput label="Note" value={form.note} onChange={(v) => setForm((f) => ({ ...f, note: v }))} />
          </div>
          <Button type="submit" title="Add" />
        </form>
      </Card>

      <Card title={`Expenses • Total: ${state.settings.currency}${fmt(total)}`} icon={FileText}>
        <Table
          columns={[
            { key: "date", title: "Date", render: (r) => new Date(r.date).toLocaleString() },
            { key: "category", title: "Category" },
            { key: "note", title: "Note" },
            { key: "amount", title: "Amount", render: (r) => `${state.settings.currency}${r.amount.toFixed(2)}` },
          ]}
          rows={state.expenses}
          empty="No expenses yet"
        />
      </Card>
    </div>
  );
}

// ------------------------------
// Reports (Admin)
// ------------------------------
function ReportsPanel({ state }) {
  const inventoryRows = state.products.map((p) => ({ id: p.id, name: p.name, category: p.category, price: p.price, stock: p.stock, value: (p.price || 0) * (p.stock || 0) }));
  const inventoryValue = inventoryRows.reduce((a, r) => a + r.value, 0);
  const revenue = state.sales.reduce((a, s) => a + s.total, 0);
  const expenseTotal = state.expenses.reduce((a, e) => a + e.amount, 0);
  const balance = revenue - expenseTotal;

  return (
    <div className="grid gap-4">
      <Card title="Inventory Report" icon={Package}>
        <div className="mb-2 text-sm">Total inventory value: <b>{state.settings.currency}{fmt(inventoryValue)}</b></div>
        <ExportCSV filename="inventory.csv" rows={inventoryRows} mapRow={(r) => r} />
      </Card>
      <Card title="Sales Report" icon={BarChart3}>
        <ExportCSV filename="sales.csv" rows={state.sales} mapRow={(s) => ({ id: s.id, date: s.date, total: s.total, items: s.items.map((i) => `${i.name} x${i.qty}`).join("; "), user: s.user })} />
      </Card>
      <Card title="Profit / Loss Summary" icon={Wallet}>
        <div className="grid grid-cols-3 gap-3 text-center">
          <KPI label="Revenue" value={`${state.settings.currency}${fmt(revenue)}`} />
          <KPI label="Expenses" value={`${state.settings.currency}${fmt(expenseTotal)}`} />
          <KPI label="Net Profit/Loss" value={`${state.settings.currency}${fmt(balance)}`} />
        </div>
      </Card>
    </div>
  );
}

// ------------------------------
// Client App (limited features)
// ------------------------------
function ClientApp({ state, setState }) {
  const [tab, setTab] = useState("dashboard");

  // Sales-only balance
  const revenue = state.sales.reduce((a, s) => a + s.total, 0);
  const balance = revenue; // <-- Only recorded sales

  return (
    <div className="max-w-6xl mx-auto px-4 py-6">
      <nav className="flex flex-wrap gap-2 mb-4">
        <TabButton icon={BarChart3} label="Dashboard" active={tab === "dashboard"} onClick={() => setTab("dashboard")} />
        <TabButton icon={ShoppingCart} label="Record Sale" active={tab === "sell"} onClick={() => setTab("sell")} />
        <TabButton icon={History} label="Sales History" active={tab === "sales"} onClick={() => setTab("sales")} />
      </nav>

      {tab === "dashboard" && (
        <div className="grid gap-4">
          <Card title="Balance Overview" icon={Wallet}>
            <div className="text-2xl font-semibold">
              {state.settings.currency}{fmt(balance)}
            </div>
            <div className="text-xs text-slate-400 mt-1">
              (Based on recorded sales)
            </div>
          </Card>
        </div>
      )}

      {tab === "sell" && <RecordSalePanel state={state} setState={setState} />}
      {tab === "sales" && <SalesHistoryPanel state={state} />}
    </div>
  );
}

// Ensure referenced components exist (smoke tests)
(function existenceTests() {
  console.assert(typeof AdminApp === "function", "AdminApp should be defined");
  console.assert(typeof ClientApp === "function", "ClientApp should be defined");
  const btn = Button({ title: "Test", onClick: () => {} });
  console.assert(!!btn, "Button returns an element");
})();

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
